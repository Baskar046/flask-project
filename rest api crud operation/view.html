<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
        <link rel="stylesheet" href="{{url_for('static',filename='bootstrap.min.css')}}">
</head>
<body>
    <div class="container">
        <div class="row justify-content-center mt-2">
            <div class="col-offset-md-3 col-md-3">
                <h3 class="text text-primary">USERS DATA</h3>
                <table id="userTable" class="table table-bordered table-striped">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>USERNAME</th>
                        <th>AGE</th>
                        <th>City</th>
                        <th>Update</th>
                        <th>Delete</th>
                    </tr>
                    </thead>
                    <tbody id="userBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-3" id="editForm" style="display:none;">
            <h4>Edit User</h4>
            <input type="hidden" id="editId">
            <div class="mb-2">
                <label>Name:</label>
                <input type="text" id="editName" class="form-control">
            </div>
            <div class="mb-2">
                <label>Age</label>
                <input type="number" id="editAge" class="form-control">
            </div>
            <div class="mb-2">
                <label>City</label>
                <input type="text" id="editCity" class="form-control">
            </div>
            <button onclick="updateUser()" class="btn btn-success">Update</button>
        </div>
    </div>


</body>
<script>
    //this command will run on page load time
    window.onload=async function(){
        try{
            const res=await fetch("http://127.0.0.1:5000/users");  //get method
            const users = await res.json();

            const tbody=document.getElementById("userBody");
            tbody.innerHTML="";  //clear old rows

            users.forEach(user =>{
                let row =`
                <tr>
                    <td>${user.ID}</td>
                    <td>${user.Student_name}</td>
                    <td>${user.Age}</td>
                    <td>${user.city}</td>
                    <td>
                    <button class="btn btn-warning btn-sm" onclick="editUser(${user.ID}, '${user.Student_name}', ${user.Age}, '${user.city}')">Update</button>
                    </td>
                    <td>

                    <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.ID})">DELETE</button>
</td>
                </tr>
                `;
                tbody.innerHTML +=row
            });
        }catch (err){
            console.log("error",err)
        }
    }


    async function deleteUser(id){
        if(confirm("Are You sure you want to delete this user")){
            try{
                const res=await fetch(`http://127.0.0.1:5000/users/${id}`,{
                    method:"DELETE"
                });

                const data= await res.json();
                alert(data.message);
                window.location.reload(); //refresh page to update table

            }catch (err){
                console.log("error deleting user",err);
            }
        }
    }

    //update user details
    function editUser(id,name,age,city){
        document.getElementById("editId").value=id;
        document.getElementById("editName").value=name;
        document.getElementById("editAge").value=age;
        document.getElementById("editCity").value=city;
        document.getElementById("editForm").style.display="block";
    }

    //send put request
    async function updateUser(){
        let id=document.getElementById("editId").value;
        let name=document.getElementById("editName").value;
        let age=document.getElementById("editAge").value;
        let city=document.getElementById("editCity").value;

        try{
            const res=await fetch(`http://127.0.0.1:5000/users/${id}`,{
                method:"PUT",
                headers:{
                    "Content-Type":"application/json"
                },
                body:JSON.stringify({name,age,city})
            });

            const result = await res.json();
            alert(result.message);

            //refresh table after update
            window.onload();

            //hide form alter update
            document.getElementById("editForm").style.display="none";
        }catch (err){
            console.log("error updating user",err)
        }

    }
</script>
</html>